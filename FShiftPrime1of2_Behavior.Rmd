---
title: "behavioral analysis"
author: "Christopher"
date: "16 6 2025"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
    theme: flatly
    df_print: paged
---



```{r load_package, message = FALSE, warning = FALSE}
library(lme4)
library(readxl)
library(tidyverse)
library(data.table)
library(tidyverse)
library(afex)
library(broom)
library(apa)
library(kableExtra)
library(lmerTest)
library(pbkrtest)
library(effects)
library(visreg)
library(sjPlot)
library(broom.mixed)
library(pander)
library(mediation)
library(multcomp)
library(multcompView)
library(magrittr)
library(multipanelfigure)
library(ggbeeswarm)
library(lsmeans)
library(BayesFactor)
library(ggpubr)
library(gpairs)
library(DescTools)
library(cowplot)
library(ggpol)
library(psych)
library(ggdist)

library(mgcv)
library(tidyverse)       # Tidy and flexible data manipulation
library(marginaleffects) # Compute conditional and marginal effects
library(patchwork)       # Combining ggplot objects


source('C:/Dropboxdata/Dropbox/work/R-statistics/general_functions/RainCloudPlots/tutorial_R/R_rainclouds.R')





# broad cluster
# CSD based normalized to pre-cue baseline in %
# 
DATAPath1 = "data_in/behavior_events.csv"
DATAPath2 = "data_in/behavior_FAs.csv"





options(scipen=1, digits=5)
```
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>


## Prepare data  
<br>  

1.  Read in data: 
    + `r DATAPath1`
    + `r DATAPath1`
    
<br>  

```{r load_data,results = "hide", fig.show = "hide", warning = FALSE}
# read in data
DataIn1 <- read_csv(DATAPath1)
DataIn2 <- read_csv(DATAPath2)
head(DataIn1)
str(DataIn1)
head(DataIn2)
str(DataIn2)

```



1.  Prepare new dataset(s)...
<br>  

```{r prepare_data1, results = "hide", fig.show = "hide", warning = FALSE}
DATA_Trials <- DataIn1%>%
  filter(eventtype=="target")


```

## Illustrate behavioral data

<br>  

```{r plot_data_avg, results = "hide",  fig.height=6, fig.width=7, warning = FALSE}

dat2plot1 <- DATA_Trials %>%
  group_by(participant, eventtype2)%>%
  summarise(
    RT_Mean=mean(RT,na.rm=TRUE),
    RT_STD=sd(RT,na.rm=TRUE),
    Hitrate=(sum(response=='hit')/n())*100,
    Hitrate_adj1 = ifelse((sum(response=='hit')/n())>0,
                         min(c(sum(response=='hit')/n(), 1-(.5/n()))),
                         .5/n()), # according to Stanislaw H, Todorov N, Behav Res Meth (1999) 31, 137-149, "1/2N rule" or
    Hitrate_adj2 = (sum(response=='hit')+0.5)/(n()+1))%>% # loglinear approach (Hautus, 1995)
    ungroup()
dat2plot1a = DataIn1%>%
  filter(eventtype=="distractor") %>%
  group_by(participant, eventtype2)%>%
  summarise(
    FArate=(sum(response=='FA_proper')/n())*100,
    FArate_adj1 = ifelse((sum(response=='FA_proper')/n())>0,
                         min(c(sum(response=='FA_proper')/n(), 1-(.5/n()))),
                         .5/n()), # according to Stanislaw H, Todorov N, Behav Res Meth (1999) 31, 137-149, "1/2N rule" or
    FArate_adj2 = (sum(response=='FA_proper')+0.5)/(n()+1)) %>% # loglinear approach (Hautus, 1995))
  ungroup()
dat2plot <- merge(dat2plot1,dat2plot1a,by = "participant") %>% # adjust for HR and FR of 0 or 1
  mutate(
    d_prime = qnorm(Hitrate_adj1)-qnorm(FArate_adj1),
    c = -0.5*(qnorm(Hitrate_adj1)+qnorm(FArate_adj1))
  ) %>%
  rename(eventtype2=eventtype2.x)


dat2plot2 <- DataIn2 %>%
  mutate(`FA_all`= FA + `FA_proper`)%>%
  # dplyr::select(-FA)%>%
  dplyr::select(-FA_all)%>%
  pivot_longer(c(-subject ),names_to = "FA_type", values_to = "number")%>%
  filter(FA_type=='FA_proper' | FA_type=='FA')

theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = 1, y = RT_Mean)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_beeswarm(cex=4.5, size = 5,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y..), geom='errorbar', width=0.9, size=1.5) +
  # scale_fill_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  # scale_color_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  ylab(expression(paste("reaction time in ms")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

plot2 <- ggplot(dat2plot, aes(x = 1, y = Hitrate)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_beeswarm(cex=4.5, size = 5,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y..), geom='errorbar', width=0.9, size=1.5) +
  # scale_fill_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  # scale_color_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange"))
  ylab(expression(paste("hit rate in %")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

plot3 <- ggplot(dat2plot2, aes(x = FA_type, y = number, color = FA_type)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_beeswarm(cex=3.5, size = 5,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y..), geom='errorbar', width=0.9, size=1.5) +
  scale_fill_manual("FA type", values=c("grey40", "black"),labels = c("to other","to distractor")) +
  scale_color_manual("FA type", values=c("grey40", "black"),labels = c("to other","to distractor")) +
  ylab(expression(paste("number of False Alarms")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

plot4 <- ggplot(dat2plot, aes(x = 1, y = d_prime)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_beeswarm(cex=4.5, size = 5,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y..), geom='errorbar', width=0.9, size=1.5) +
  # scale_fill_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  # scale_color_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange"))
  ylab(expression(paste("dprime")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())


# cowplot::plot_grid(plot1, plot2, plot3, ncol = 3,labels = "AUTO")
plotttitle <- ggdraw() + draw_label("behavioral measures", fontface='bold')
plotplots <- ggarrange(plot1, plot2, plot3, plot4, ncol = 4, align = "h", widths=c(2,2,5,2))
ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))




## for publication
theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = eventtype2, y = RT_Mean, color =eventtype2,)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_beeswarm(cex=4.5, size = 5,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y..), geom='errorbar', width=0.9, size=1.5) +
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  # scale_fill_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  # scale_color_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  ylab(expression(paste("reaction time in ms")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  scale_y_continuous(limits=c(400, 775))

plot1b <- ggplot(dat2plot, aes(x = 1, y = RT_Mean, color =eventtype2, fill = eventtype2)) +
  geom_flat_violin(position = position_nudge(x = .1, y = 0), adjust = 1.0, trim = FALSE, alpha = 0.8)+
  # scale_fill_manual(values=c("grey40"))+
  scale_fill_brewer(palette = "Dark2")+
  # scale_color_manual(values=c("grey40"))+
  scale_color_brewer(palette = "Dark2")+
  theme(axis.title.y=element_blank(),
         axis.text.y=element_blank(),
         axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_y_continuous(limits=c(400, 775))

plot2 <- ggplot(dat2plot, aes(x = eventtype2, y = Hitrate, color =eventtype2)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_beeswarm(cex=4.5, size = 5,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y..), geom='errorbar', width=0.9, size=1.5) +
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
    # scale_fill_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  # scale_color_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange"))
  ylab(expression(paste("hit rate in %")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  scale_y_continuous(limits=c(30, 100))

plot2b <- ggplot(dat2plot, aes(x = 1, y = Hitrate,  color =eventtype2, fill = eventtype2)) +
  geom_flat_violin(position = position_nudge(x = .1, y = 0), adjust = 1.0, trim = FALSE, alpha = 0.8)+
  # scale_fill_manual(values=c("grey40"))+
  scale_fill_brewer(palette = "Dark2")+
  # scale_color_manual(values=c("grey40"))+
  scale_color_brewer(palette = "Dark2")+
  theme(axis.title.y=element_blank(),
         axis.text.y=element_blank(),
         axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_y_continuous(limits=c(30, 100))

  

# cowplot::plot_grid(plot1, plot2, plot3, ncol = 3,labels = "AUTO")
plotttitle <- ggdraw() + draw_label("behavioral measures", fontface='bold')
plotplots <- ggarrange(plot1, plot1b,plot2, plot2b, ncol = 4,common.legend = TRUE,align = "h", widths=c(3,2,3,2))

savefig <- multi_panel_figure(columns = 1, rows = 1, panel_label_type = "none", width = 5, height = 6, unit = "in")
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))

savefig %<>%
  fill_panel(saveplot, column = 1, row = 1)
savefig
# save_multi_panel_figure(savefig, "hits_reactiontimes.eps")


## for publication
theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = eventtype2, y = RT_Mean, color =eventtype2)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_beeswarm(cex=4.5, size = 5,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y..), geom='errorbar', width=0.9, size=1.5) +
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  # scale_fill_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  # scale_color_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  ylab(expression(paste("reaction time in ms")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  scale_y_continuous(limits=c(400, 775))

plot1b <- ggplot(dat2plot, aes(x = 1, y = RT_Mean, color =eventtype2, fill = eventtype2)) +
  geom_flat_violin(position = position_nudge(x = .1, y = 0), adjust = 1.0, trim = FALSE, alpha = 0.8)+
  # scale_fill_manual(values=c("grey40"))+
  scale_fill_brewer(palette = "Dark2")+
  # scale_color_manual(values=c("grey40"))+
  scale_color_brewer(palette = "Dark2")+
  theme(axis.title.y=element_blank(),
         axis.text.y=element_blank(),
         axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_y_continuous(limits=c(400, 775))

plot2 <- ggplot(dat2plot, aes(x = eventtype2, y = d_prime, color =eventtype2)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_beeswarm(cex=4.5, size = 5,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y..), geom='errorbar', width=0.9, size=1.5) +
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  # scale_fill_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange")) +
  # scale_color_manual("attended color", values=c("darkcyan", "darkgreen", "darkorange"))
  ylab(expression(paste("dprime")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  scale_y_continuous(limits=c(0.0, 3.8))

plot2b <- ggplot(dat2plot, aes(x = 1, y = d_prime, color =eventtype2, fill = eventtype2)) +
  geom_flat_violin(position = position_nudge(x = .1, y = 0), adjust = 1.0, trim = FALSE, alpha = 0.8)+
  # scale_fill_manual(values=c("grey40"))+
  scale_fill_brewer(palette = "Dark2")+
  # scale_color_manual(values=c("grey40"))+
  scale_color_brewer(palette = "Dark2")+
  theme(axis.title.y=element_blank(),
         axis.text.y=element_blank(),
         axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_y_continuous(limits=c(0.0, 3.8))

  

# cowplot::plot_grid(plot1, plot2, plot3, ncol = 3,labels = "AUTO")
plotttitle <- ggdraw() + draw_label("behavioral measures", fontface='bold')
plotplots <- ggarrange(plot1, plot1b,plot2, plot2b, ncol = 4,common.legend = TRUE,align = "h", widths=c(3,2,3,2))

savefig <- multi_panel_figure(columns = 1, rows = 1, panel_label_type = "none", width = 5, height = 6, unit = "in")
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))

savefig %<>%
  fill_panel(saveplot, column = 1, row = 1)
savefig
# save_multi_panel_figure(savefig, "dprime_reactiontimes.eps")
  

```


## Display behavioral data numerically

<br>  

```{r disp_data_avg, warning = FALSE}
dat2plot1 <- DATA_Trials %>%
  group_by(eventtype2, participant )%>%
  summarise(
    RT_Mean=mean(RT,na.rm=TRUE),
    RT_STD=sd(RT,na.rm=TRUE),
    Hitrate=(sum(response=='hit')/n())*100,
    Hitrate_adj1 = ifelse((sum(response=='hit')/n())>0,
                         min(c(sum(response=='hit')/n(), 1-(.5/n()))),
                         .5/n()), # according to Stanislaw H, Todorov N, Behav Res Meth (1999) 31, 137-149, "1/2N rule" or
    Hitrate_adj2 = (sum(response=='hit')+0.5)/(n()+1)) # loglinear approach (Hautus, 1995)

dat2plot1a = DataIn1%>%
  filter(eventtype=="distractor") %>%
  group_by(eventtype2, participant)%>%
  summarise(
    FArate=(sum(response=='FA_proper')/n())*100,
    FArate_adj1 = ifelse((sum(response=='FA_proper')/n())>0,
                         min(c(sum(response=='FA_proper')/n(), 1-(.5/n()))),
                         .5/n()), # according to Stanislaw H, Todorov N, Behav Res Meth (1999) 31, 137-149, "1/2N rule" or
    FArate_adj2 = (sum(response=='FA_proper')+0.5)/(n()+1)) # loglinear approach (Hautus, 1995))

dat2plot <- merge(dat2plot1,dat2plot1a,by = "participant") %>% # adjust for HR and FR of 0 or 1
  mutate(
    d_prime = qnorm(Hitrate_adj1)-qnorm(FArate_adj1),
    c = -0.5*(qnorm(Hitrate_adj1)+qnorm(FArate_adj1))
  ) %>%
  rename(eventtype2=eventtype2.x)

dat2plot  %>%
  group_by(eventtype2)%>%
  summarise(N = n(), mean_RT = mean(RT_Mean), std_RT = sd(RT_Mean), mean_Hitrate = mean(Hitrate), std_Hitrate = sd(Hitrate),
            mean_FArate = mean(FArate), std_FArate = sd(FArate), mean_dprime = mean(d_prime), std_dprime = sd(d_prime)) %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3,3), caption = c("descriptives of behavioral measures")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

```



## Statistical analysis

### ANOVA models
### linear mixed models

#### test RT, Hitrate and dprime between primed and non primed targets

**RT** ~ **priming**

<br> 

```{r lme_RT_lum, fig.show = "hide", warning = FALSE, fig.height=4, fig.width=10}
dat2plot2 <- DataIn2 %>%
  mutate(`FA_all`= FA + `FA_proper`)%>%
  # dplyr::select(-FA)%>%
  dplyr::select(-FA_all)%>%
  pivot_longer(c(-subject ),names_to = "FA_type", values_to = "number")%>%
  filter(FA_type=='FA_proper' | FA_type=='FA')


dat2plot1 <- DATA_Trials %>%
  group_by(participant,eventtype2)%>%
  summarise(RT_Mean=mean(RT,na.rm=TRUE),RT_STD=sd(RT,na.rm=TRUE),Hitrate=(sum(response=='hit')/n())*100)

dat2plot2 <- DataIn2 %>%
  mutate(`FA_all`= FA + `FA_proper`)%>%
  # dplyr::select(-FA)%>%
  dplyr::select(-FA_all)%>%
  rename(participant=subject)

dat2plot_all <- merge(dat2plot1,dat2plot2,by = "participant") %>% # adjust for HR and FR of 0 or 1
  mutate(
    d_prime = qnorm(Hitrate)-qnorm(FA_proper_rate),
    c = -0.5*(qnorm(Hitrate)+qnorm(FA_proper_rate))
  )



# # statisticical analysis ANOVA
# StatsOut <- dat2plot_all %>%
#   aov_ez(id="participant", dv = "RT_Mean", data = ., between = c("colorlum"), include_aov = afex_options("include_aov"))
# 
# StatsOut%>%
#   .$anova %>%
#   mutate(factor = rownames(.))%>%
#   mutate(
#     `Pr(>F)` = cell_spec(ifelse(round(`Pr(>F)`,4)<.001,"< .001",round(`Pr(>F)`,4)),
#                         color = ifelse(is.nan(`Pr(>F)`),"blue", ifelse(`Pr(>F)` < .05, "green", "red")),
#                         bold = ifelse(is.nan(`Pr(>F)`),F, ifelse(`Pr(>F)` < .05, T,F)),
#                         align = "center")
#   ) %>%
#   dplyr::select(`num Df`, `den Df`, MSE, `F`, ges, `Pr(>F)`) %>%
#   kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("ANOVA | dv = RT in ms")) %>%
#   kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 6))


# RT
dat2plot_all %>%
  nest() %>%
  mutate(
    # stats = map(data, ~ broom::tidy(t.test(RT_Mean ~ eventtype2, data = ., paired = TRUE))),
    stats = map(data, ~ rstatix::t_test(RT_Mean ~ eventtype2, data = ., paired = TRUE, detailed = TRUE)),
    t_test_bf = map(data, ~ extractBF(ttestBF(formula = RT_Mean ~ eventtype2, data = ., 
                                              iterations = num.iter, rscale = sqrt(2)/2))),
    meanval = map(data, ~ .x %>%
                    group_by(eventtype2) %>%
                    summarise(
                      mean_RT_Mean = mean(RT_Mean, na.rm = TRUE),
                      std_RT_Mean = sd(RT_Mean, na.rm = TRUE)
                    ) %>%
                    pivot_wider(names_from = eventtype2, 
                                values_from = c(mean_RT_Mean, std_RT_Mean), 
                                names_sep = "_")
    ),
    Dz = map(data, ~ rstatix::cohens_d(RT_Mean ~ eventtype2, data = ., paired = TRUE))
  ) %>%
  # unnest(cols = c(stats, cohens_d, t_test_bf, meanval))%>%
  unnest(cols = c(Dz))%>%
  dplyr::select(stats,t_test_bf, meanval, effsize) %>%
  unnest(cols = c(stats, t_test_bf, meanval)) %>%
  mutate(BF10 = bf, BF01 = 1/bf, 
         M_RT_noprim = mean_RT_Mean_target_nonprimed,
         SD_RT_noprim = std_RT_Mean_target_nonprimed,
         M_RT_prim = mean_RT_Mean_target_primed,
         SD_RT_prim = std_RT_Mean_target_primed,
         diff=estimate,
         Dz = effsize, t.value=statistic)%>%
  dplyr::select(M_RT_noprim, SD_RT_noprim, M_RT_prim, SD_RT_prim, diff, t.value, df, p, Dz, BF10, BF01)%>%
  # mutate(p = p.adjust(p, method="holm")) %>% # none, holm
  # mutate(p = p.adjust(p, method="none")) %>% # none, holm
  ungroup()%>%
  # mutate(
  #   p = cell_spec(p, color = ifelse(is.nan(p),"blue", ifelse(p < .05, "green", "red")))
  # ) %>%
  mutate(
    p = cell_spec(ifelse(round(p,4)<.001,"< .001",round(p,4)),
                  color = ifelse(is.nan(p),"blue", ifelse(p < .05, "green", "red")),
                  bold = ifelse(is.nan(p),F, ifelse(p < .05, T,F)),
                  align = "center")
  ) %>%
  kbl(escape = F, digits = 3, 
        caption = c("RT | modulation by target type (primed vs nonprimed) | t-tests of difference")) %>%
  kable_styling("striped", full_width = T,bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
```

**Hitrate** ~ **priming**

<br> 

```{r lme_HR_lum, fig.show = "hide", warning = FALSE, fig.height=4, fig.width=10}
# Hitrate
dat2plot_all %>%
  nest() %>%
  mutate(
    # stats = map(data, ~ broom::tidy(t.test(Hitrate ~ eventtype2, data = ., paired = FALSE))),
    stats = map(data, ~ rstatix::t_test(Hitrate ~ eventtype2, data = ., paired = TRUE, detailed = TRUE)),
    t_test_bf = map(data, ~ extractBF(ttestBF(formula = Hitrate ~ eventtype2, data = ., iterations = num.iter, rscale = sqrt(2)/2))),
    meanval = map(data, ~ .x %>%
                    group_by(eventtype2) %>%
                    summarise(
                      mean_HR_Mean = mean(Hitrate, na.rm = TRUE),
                      std_HR_Mean = sd(Hitrate, na.rm = TRUE)
                    ) %>%
                    pivot_wider(names_from = eventtype2, 
                                values_from = c(mean_HR_Mean, std_HR_Mean), 
                                names_sep = "_")
    ),
    cohens_d = map(data, ~ rstatix::cohens_d(Hitrate ~ eventtype2, data = ., paired = FALSE))
  ) %>%
  # unnest(cols = c(stats, cohens_d, t_test_bf, meanval))%>%
  unnest(cols = c(cohens_d))%>%
  dplyr::select(stats,t_test_bf, meanval, effsize) %>%
  unnest(cols = c(stats, t_test_bf, meanval)) %>%
  mutate(BF10 = bf, BF01 = 1/bf, 
         M_HR_noprim = mean_HR_Mean_target_nonprimed,
         SD_HR_noprim = std_HR_Mean_target_nonprimed,
         M_HR_prim = mean_HR_Mean_target_primed,
         SD_HR_prim = std_HR_Mean_target_primed,
         diff=estimate,
         Dz = effsize, t.value=statistic)%>%
  dplyr::select(M_HR_noprim, SD_HR_noprim, M_HR_prim, SD_HR_prim, diff, t.value, df, p, Dz, BF10, BF01)%>%
  # mutate(p = p.adjust(p, method="holm")) %>% # none, holm
  # mutate(p = p.adjust(p, method="none")) %>% # none, holm
  ungroup()%>%
  mutate(
    p = cell_spec(ifelse(round(p,4)<.001,"< .001",round(p,4)),
                        color = ifelse(is.nan(p),"blue", ifelse(p < .05, "green", "red")),
                        bold = ifelse(is.nan(p),F, ifelse(p < .05, T,F)),
                        align = "center")
  ) %>%
  kbl(escape = F, digits = 3, 
        caption = c("Hitrate | modulation by target type (primed vs nonprimed) | t-tests of difference")) %>%
  kable_styling("striped", full_width = T,bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
```

## Additional analyses


### Display of additiona analyses
What are the distributions of presentation times for detected primed and nonprimed events?

<br> 

```{r disp_hitxpresentationtime_distr, fig.height=6, fig.width=7, warning = FALSE}
# DATA_Trials %>%
#   filter(response=='hit') %>%
#   group_by(eventtype2, participant) %>%
#   summarise(
#     mean_presentation_time = mean(eventonsettimes, na.rm = TRUE),
#     std_presentation_time = sd(eventonsettimes, na.rm = TRUE)
#   ) %>%
#   ungroup() %>%
#   mutate(
#     eventtype2 = factor(eventtype2, levels = c("target_nonprimed", "target_primed"))
#   ) %>%
#   ggplot(aes(x = eventtype2, y = mean_presentation_time)) +
#   geom_bar(stat = "identity", position = position_dodge(), fill = "steelblue") +
#   geom_errorbar(aes(ymin = mean_presentation_time - std_presentation_time, ymax = mean_presentation_time + std_presentation_time), width = 0.2, position = position_dodge(0.9)) +
#   labs(x = "Event Type", y = "Mean Presentation Time (ms)") +
#   theme_minimal()


DATA_Trials %>%
  ggplot(aes(y = interaction(eventtype2,response), x = eventonsettimes, fill=response)) +
  stat_halfeye(position = position_dodgejust(width = .2)) +
  # stat_histinterval() +
  # stat_slab(height = 2, color = "black")+
  # stat_dots(color = "grey")+
  # stat_dots(quantiles = 90, color = "grey",fill="darkgrey")+
  # stat_dots(quantiles = 90, color = "grey")+
  ggtitle("presentation times of hits and misses separate for cued targets")

DATA_Trials %>%
  ggplot(aes( x = eventonsettimes,  fill=eventtype2)) +
  geom_density(alpha=0.4,bw=0.1) +
  # stat_density(adjust = 0.5, alpha=0.4)+
  facet_grid(response~.)+
  # stat_histinterval() +
  # stat_slab(height = 2, color = "black")+
  # stat_dots(color = "grey")+
  # stat_dots(quantiles = 90, color = "grey",fill="darkgrey")+
  # stat_dots(quantiles = 90, color = "grey")+
  ggtitle("presentation times of hits and misses separate for cued targets")

DATA_Trials %>%
  ggplot(aes( x = eventonsettimes,  fill=eventtype2)) +
  geom_density(alpha=0.4,bw=0.1) +
  # stat_density(adjust = 0.5, alpha=0.4)+
  facet_grid(eventtype2~.)+
  # stat_histinterval() +
  # stat_slab(height = 2, color = "black")+
  # stat_dots(color = "grey")+
  # stat_dots(quantiles = 90, color = "grey",fill="darkgrey")+
  # stat_dots(quantiles = 90, color = "grey")+
  ggtitle("presentation times separate for cued targets")


DATA_Trials %>%
  ggplot(aes(y = interaction(eventtype2), x = eventonsettimes,  fill=eventtype2))+
  stat_halfeye(position = position_dodgejust(width = .2)) +
  # stat_histinterval() +
  # stat_slab(height = 2, color = "black")+
  # stat_dots(color = "grey")+
  # stat_dots(quantiles = 90, color = "grey",fill="darkgrey")+
  # stat_dots(quantiles = 90, color = "grey")+
  ggtitle("presentation times separate for cued targets")


DATA_Trials %>%
  filter(response=='hit')%>%
  ggplot(aes(x = eventonsettimes, y = RT, color = eventtype2)) +
  stat_summary(fun = mean, geom = "point", alpha = 0.4) +  # mean RTs
  geom_smooth(method = "loess", se = TRUE, span = 0.3) +    # kernel smoothed average
  labs(
    title = "Smoothed Average Reaction Times",
    x = "Presentation Time (ms)",
    y = "Reaction Time (ms)",
    color = "Condition"
  ) +
  theme_minimal()

```


### Display of additiona analyses | displayed differently
What are the distributions of presentation times for detected primed and nonprimed events?

<br> 

```{r disp_hitxpresentationtime_distr_v2, fig.height=4, fig.width=7, warning = FALSE}
data_bin <- DATA_Trials %>%
  mutate(hit = ifelse(response == "hit", 1, 0))

data_avg <- data_bin %>%
  group_by(eventtype2, eventonsettimes) %>%
  summarise(hit_rate = mean(hit), .groups = "drop")


ggplot(data_bin, aes(x = eventonsettimes, y = hit, color = eventtype2)) +
  stat_summary(fun = mean, geom = "point", alpha = 0.4) +  # mean RTs
  geom_smooth(method = "loess", span = 0.3, se = TRUE) +
  labs(x = "Event Onset Time", y = "Hit Rate", 
       title = "Smoothed Hit Rates Over Time by Condition") +
  theme_minimal()

ggplot(data_avg, aes(x = eventonsettimes, y = hit_rate, color = eventtype2)) +
  # geom_line(alpha = 0.4) +
  stat_summary(fun = mean, geom = "point", alpha = 0.4) +  # mean RTs
  geom_smooth(method = "loess", se = TRUE, span = 0.3) +
  labs(x = "Event Onset Time", y = "Hit Rate", 
       title = "Smoothed Hit Rates Over Time by Condition") +
  theme_minimal()


ggplot(data_bin, aes(x = eventonsettimes, y = hit, color = eventtype2)) +
  stat_summary(fun = mean, geom = "point", alpha = 0.4) +  # mean RTs
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs", k = 10), se = TRUE) +
  labs(x = "Event Onset Time", y = "Hit Rate", 
       title = "GAM Smoothed Hit Rates by Condition") +
  theme_minimal()
```


### Statistical test of additiona analyses
#### Do we see differences in the distributions of hits for both cued targets across time?

full model: response ~ eventtype2 * eventonsettimes + (1 | participant)
reduced model: response ~ eventtype2 + eventonsettimes + (1 | participant)

<br> 
```{r stat_hitxpresentationtime_distr, fig.show = "hide", warning = FALSE, fig.height=4, fig.width=10}
# Full model with interaction
GLMHit_full <- DATA_Trials %>%
  mutate(response = as.factor(response)) %>%
  glmer(response ~ eventtype2 * eventonsettimes + (1 | participant),data=., family = binomial)

# Reduced model without the interaction
GLMHit_reduced <- DATA_Trials %>%
  mutate(response = as.factor(response)) %>%
  glmer(response ~ eventtype2 + eventonsettimes + (1 | participant),data=., family = binomial)

# Likelihood ratio test
anova( GLMHit_reduced, GLMHit_full, test = "Chisq") %>%
  as.data.frame() %>%
  kable(escape = F, digits=3,
        caption = paste0("Likelihood ratio test via anova | comparing full and reduced model:<br>", 
                    deparse(formula(GLMHit_full))))%>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8,latex_options = "hold_position"))

# Display the summary of the full model + Wald test
GLMHit_full %>%
  tidy() %>%
  kable(escape = F, digits=3,
        caption = paste0("Likelihood ratio test via anova | comparing full and reduced model:<br>", 
                    deparse(formula(GLMHit_full)))) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

```
#### Control Analysis: Are there differences in the distributions of event times for both cueing conditons?

<br> 
```{r stat_hitxpresentationtime_distr_control, fig.show = "hide", warning = FALSE, fig.height=4, fig.width=10}
GLMEventType_full <- DATA_Trials %>%
  mutate(eventtype2 = as.factor(eventtype2)) %>%
  glmer(eventtype2 ~ eventonsettimes + (1 | participant),data=., family = binomial)


# Display the summary of the full model + Wald test
summary(GLMEventType_full)

```

### Display of additiona analyses | Reaction times
What are the distributions of reaction times for primed and nonprimed events across the trial?

<br> 

```{r disp_RTxpresentationtime_distr, fig.height=4, fig.width=7, warning = FALSE}
DATA_Trials %>%
  filter(response=='hit')%>%
  ggplot(aes(x = eventonsettimes, y = RT, color = eventtype2)) +
  stat_summary(fun = mean, geom = "point", alpha = 0.4) +  # mean RTs
  geom_smooth(method = "loess", se = TRUE, span = 0.3) +    # kernel smoothed average
  labs(
    title = "Smoothed Average Reaction Times",
    x = "eventonsettimes (s)",
    y = "Reaction Time (ms)",
    color = "Condition"
  ) +
  theme_minimal()

DATA_Trials %>%
  filter(response=='hit')%>%
  ggplot(aes(x = eventonsettimes, y = RT, color = eventtype2)) +
  stat_summary(fun = mean, geom = "point", alpha = 0.4) +  # mean RTs
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs",  k = 10), se = TRUE) +    # kernel smoothed average
  labs(
    title = "GAM Smoothed Average Reaction Times",
    x = "eventonsettimes (s)",
    y = "Reaction Time (ms)",
    color = "Condition"
  ) +
  theme_minimal()




```

### Statistical test of additiona analyses
#### Do we see differences in the distributions of reaction times for primed and nonprimed events across the trial?

full model: response ~ eventtype2 * eventonsettimes + (1 | participant)

reduced model: response ~ eventtype2 + eventonsettimes + (1 | participant)

<br> 
```{r stat_RTxpresentationtime_distr,  warning = FALSE, fig.height=4, fig.width=6}
# Full model with interaction
LMRT_full <- DATA_Trials %>%
  filter(response=='hit')%>%
  lmer(RT ~ eventtype2 * eventonsettimes + (1 | participant),data=.)

# Reduced model without the interaction
LMRT_reduced <- DATA_Trials %>%
  filter(response=='hit')%>%
  glmer(RT ~ eventtype2 + eventonsettimes + (1 | participant),data=.)

# Likelihood ratio test
anova( LMRT_reduced, LMRT_full, test = "Chisq") %>%
  as.data.frame() %>%
  kable(escape = F, digits=3,
        caption = paste0("Likelihood ratio test via anova | comparing full and reduced model:<br>", 
                    deparse(formula(LMRT_full))))%>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8,latex_options = "hold_position"))

# Display the summary of the full model + Wald test
LMRT_full %>%
  tidy() %>%
  kable(escape = F, digits=3,
        caption = paste0("Likelihood ratio test via anova | display of full model:<br>", 
                    deparse(formula(LMRT_full)))) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))



# Model with smoothers by condition
model_gam_interaction <- DATA_Trials %>%
  filter(response=='hit')%>%
  mutate(eventtype2 = as.factor(eventtype2))%>%
  gam(RT ~ eventtype2 + s(eventonsettimes, by = eventtype2) + s(participant, bs = "re"), 
                 data = .)

model_gam_null <- DATA_Trials %>%
  filter(response=='hit')%>%
  mutate(eventtype2 = as.factor(eventtype2))%>%
  gam(RT ~ eventtype2 + s(eventonsettimes) + s(participant, bs = "re"), 
                 data = .)

plot(model_gam_interaction, pages = 1)
# anova(model_gam_interaction)


plot_predictions(model_gam_interaction, condition = c('eventonsettimes', 'eventtype2'),
                 type = 'link') +
      labs(y = "Linear predictor (link scale)",
           title = "Average smooth effect of eventonsettimes | GAM",
           subtitle = "Per priming condition")


# Likelihood ratio test
anova( model_gam_null, model_gam_interaction, test = "Chisq") %>%
  as.data.frame() %>%
  kbl(escape = F, digits=3,
        caption = paste0("Likelihood ratio test via anova | comparing full and reduced model | GAM:<br>", 
                    paste(deparse(formula(model_gam_interaction)), collapse = " ")))%>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8,latex_options = "hold_position"))

```